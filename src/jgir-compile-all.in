#!/usr/bin/python
import os,sys,subprocess

classpath="@CLASSPATH@"
java_opts=os.environ.get('JAVA_OPTS', None)
if java_opts:
    java_opts = java_opts.split(' ')
else:
    java_opts = []
datadirs = os.environ.get('XDG_DATA_DIRS', '/usr/share')
nsversions = []
for dirname in datadirs.split(':'):
    repodir = os.path.join(dirname, 'girepository')
    if not os.access(repodir, os.W_OK):
        continue
    for name in os.listdir(repodir):
        if not name.endswith('.typelib'):
            continue
        base,_ = os.path.splitext(name)
        nsversions.append(base)
        print "%r" % (base, )
        ns,version = base.rsplit('-', 1)
        args = ['java']
        args.extend(java_opts)
        args.extend(['-cp', classpath, 'org.gnome.gir.compiler.CodeFactory', ns, version])
        subprocess.check_call(args,
                              stdout=sys.stdout,
                              stderr=sys.stderr,
                              close_fds=True)
subprocess.check_call(['java', '-cp', classpath, 'org.gnome.gir.compiler.CodeFactory',
                       '--verify', ','.join(nsversions)],
                      stdout=sys.stdout,
                      stderr=sys.stderr,
                      close_fds=True)

